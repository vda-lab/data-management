<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" lambda">
<title>Serving layer | Data Management</title>
<link rel="stylesheet" href="css/syntax.css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/boxshadowproperties.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="css/theme-custom.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="data-management" href="http://localhost:4000/feed.xml">

<script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@4"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    TeX: {
      equationNumbers: {
        autoNumber: "AMS"
      }
    },
    tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$'] ],
    processEscapes: true,
  }
});
MathJax.Hub.Register.MessageHook("Math Processing Error",function (message) {
	  alert("Math Processing Error: "+message[1]);
	});
MathJax.Hub.Register.MessageHook("TeX Jax - parse error",function (message) {
	  alert("Math Processing Error: "+message[1]);
	});
</script>
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> Data Management</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>
                <!-- entries without drop-downs appear here -->




                
                
                
                <li><a href="https://github.com/vda-lab/data-management" target="_blank" rel="noopener">GitHub</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Contents<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="rdbms_landing_page.html">Relational databases and SQL</a></li>
                        
                        
                        
                        <li><a href="nosql_landing_page.html">NoSQL</a></li>
                        
                        
                        
                        <li><a href="lambda_landing_page.html">Lambda architecture</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Serving layer">{title}</a></li>',
                    noResultsText: '',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                

<ul id="mysidebar" class="nav">
  <li class="sidebarTitle">Lambda architecture </li>
  
  
  
      
  
      
  
  <li>
      <a title="SQL vs NoSQL" href="#">SQL vs NoSQL</a>
      <ul>
          
          
          
          <li><a title="Introduction" href="lambda-sqlvsnosql-introduction.html">Introduction</a></li>
          
          
          
          
          
          
          <li><a title="Keep components simple" href="lambda-sqlvsnosql-keep-components-simple.html">Keep components simple</a></li>
          
          
          
          
          
          
          <li><a title="Application tiers" href="lambda-sqlvsnosql-application-tiers.html">Application tiers</a></li>
          
          
          
          
          
          
          <li><a title="Memory locations" href="lambda-sqlvsnosql-memory-locations.html">Memory locations</a></li>
          
          
          
          
          
          
          <li><a title="Cache" href="lambda-sqlvsnosql-cache.html">Cache</a></li>
          
          
          
          
          
          
          <li><a title="ACID vs BASE" href="lambda-sqlvsnosql-acid-vs-base.html">ACID vs BASE</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="Lambda architecture" href="#">Lambda architecture</a>
      <ul>
          
          
          
          <li><a title="Introduction" href="lambda-architecture-introduction.html">Introduction</a></li>
          
          
          
          
          
          
          <li><a title="Batch layer" href="lambda-batch-layer.html">Batch layer</a></li>
          
          
          
          
          
          
          <li class="active"><a title="Serving layer" href="lambda-serving-layer.html">Serving layer</a></li>
          
          
          
          
          
          
          <li><a title="Speed layer" href="lambda-speed-layer.html">Speed layer</a></li>
          
          
          
          
          
          
          <li><a title="An example" href="lambda-example.html">An example</a></li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block: -->
         <!-- <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p> -->

</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <div class="post-header">
   <h1 class="post-title-main">Serving layer</h1>
</div>



<div class="post-content">

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    


    

   <p>The serving layer contains one or more versions of the data in a form that we want for specific questions. Let’s look at the friends example from above. We want to keep the original data in the batch layer, but also want to have easier versions to work with. These versions are computed by the batch layer, and are made available in what is called the <em>serving layer</em>.</p>

<p><img src="/assets/friends-1.png" alt="friends-1" /></p>

<p>The “friend_counts” table, for example, can then be queried easily to get the number of friends for every individual. The serving layer therefore contains <em>versions of the data optimised for answering specific questions</em>.</p>

<p>This recomputation can be triggered by different things: it might start automatically when the previous round of recomputation has finished, it might start automatically whenever new data has been added, or (as in the example at the end of this post) it might be done on the fly when you’re for example using SQL views.</p>

<h2 id="making-multiple-views">Making multiple views</h2>
<p>Remember when we talked about <a href="/2019/09/beyond-sql#44-data-modelling">data modeling</a> in document-databases, that the way that the documents are embedded can have huge effects on performance. In our example there, genotypes could be organised by individual or by SNP.</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w"> </span><span class="err">name:</span><span class="w"> </span><span class="s2">"Tom"</span><span class="p">,</span><span class="w">
  </span><span class="err">ethnicity:</span><span class="w"> </span><span class="s2">"African"</span><span class="p">,</span><span class="w">
  </span><span class="err">genotypes:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="err">snp:</span><span class="w"> </span><span class="s2">"rs0001"</span><span class="p">,</span><span class="w">
      </span><span class="err">genotype:</span><span class="w"> </span><span class="s2">"A/A"</span><span class="p">,</span><span class="w">
      </span><span class="err">position:</span><span class="w"> </span><span class="s2">"1_8271"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="err">snp:</span><span class="w"> </span><span class="s2">"rs0002"</span><span class="p">,</span><span class="w">
      </span><span class="err">genotype:</span><span class="w"> </span><span class="s2">"A/G"</span><span class="p">,</span><span class="w">
      </span><span class="err">position:</span><span class="w"> </span><span class="s2">"1_127279"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="err">snp:</span><span class="w"> </span><span class="s2">"rs0003"</span><span class="p">,</span><span class="w">
      </span><span class="err">genotype:</span><span class="w"> </span><span class="s2">"C/C"</span><span class="p">,</span><span class="w">
      </span><span class="err">position:</span><span class="w"> </span><span class="s2">"1_82719"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">]}</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="err">name:</span><span class="w"> </span><span class="s2">"John"</span><span class="p">,</span><span class="w">
  </span><span class="err">ethnicity:</span><span class="w"> </span><span class="s2">"Caucasian"</span><span class="p">,</span><span class="w">
  </span><span class="err">...</span></code></pre></figure>

<p>versus</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w"> </span><span class="err">snp:</span><span class="w"> </span><span class="s2">"rs0001"</span><span class="p">,</span><span class="w">
  </span><span class="err">position:</span><span class="w"> </span><span class="s2">"1_8271"</span><span class="p">,</span><span class="w">
  </span><span class="err">genotypes:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="err">name:</span><span class="w"> </span><span class="s2">"Tom"</span><span class="p">,</span><span class="w">
      </span><span class="err">ethnicity:</span><span class="w"> </span><span class="s2">"African"</span><span class="p">,</span><span class="w">
      </span><span class="err">genotype:</span><span class="w"> </span><span class="s2">"A/A"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="err">name:</span><span class="w"> </span><span class="s2">"John"</span><span class="p">,</span><span class="w">
      </span><span class="err">ethnicity:</span><span class="w"> </span><span class="s2">"Caucasian"</span><span class="p">,</span><span class="w">
      </span><span class="err">genotype:</span><span class="w"> </span><span class="s2">"A/A"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">]}</span></code></pre></figure>

<p>In a lambda architecture, if you know that you have to be able to answer both “what are the genotypes for a particular individual” and “what are the genotypes for a particular SNP” regularly, you’ll just create both versions of the data in the serving layer. You might think that this is dangerous because you might end up with inconsistencies when you have to update something. This was one of the reasons that we went for normalisation when we were talking about <a href="http://vda-lab.be/2019/08/extended-introduction-to-relational-databases">relational databases</a>. There is however a big difference here: when we need to make a change, that change is added to the <em>batch</em> layer and would trickle down automatically to <em>both</em> versions in the serving layer.</p>

<h2 id="recomputation-updates">Recomputation updates</h2>
<p>The code necessary to create these “views” on the data is typically very simple. The batch layer continuously <em>recomputes</em> these views, which are then exposed in the serving layer (called <em>batch views</em>). These computations are conceptually very simple, because they always take all the data into consideration and basically <em>delete the view and replace it with a completely new version</em>. These are so-called <em>recomputation updates</em>, which are very different from <em>incremental updates</em>, in which the view remains where it is and only those parts that changed are updated. If the recomputation update is finished, it basically starts all over again.</p>

<h2 id="serving-layer-is-out-of-date">Serving layer is out of date</h2>
<p>This approach does have a drawback, and that is that the data in the serving layer will always be out of date: the recomputation takes the data that is in the batch layer <em>at the moment the computation begins</em>, and does not look at any data that is added afterwards. Consider the image below. Let’s say that at timepoint t1 we have a serving layer and start its recomputation from the batch layer, and the recomputation is finished at t4. At timepoint t2 new data is added to the batch layer, but is not considered in the recomputation because that only took data into account that was in the batch layer at the start of the recomputation. At t3 we want to query the database (via the serving layer), and will miss the dark and the red datapoints because they are not in the serving layer yet. If we’d perform the same query at timepoint t4 we would include the dark grey datapoint.</p>

<p><img src="/assets/servinglayer-outofdate2.png" width="400px" /></p>

<p>Similarly, adding a record in the friends batch layer will take some time to become visible in the serving layer.</p>

<p><img src="/assets/friends-2.png" alt="friends-2" /></p>

<p>In many cases, having a serving layer that is slightly out of date is not really a problem. Think for example of the online store shopping cart mentioned above.</p>

<p>If it is really necessary to have the result of queries to be constantly up-to-date, we need a speed layer as well.</p>

<div class="seriesContext">
  
  
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
      
  
  

  
    <a href="lambda-speed-layer.html"><button type="button" class="btn btn-primary">Next: Speed layer</button></a>
  
</div>



    <div class="tags">
        
    </div>




</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2021 Visual Data Analysis Lab. All rights reserved. <br />
 Site last generated: Nov 22, 2021 <br />
<p><img src="images/company_logo.png" alt="Company logo"/></p>
                </div>
            </div>
</footer>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

</html>
