<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" nosql">
<title>Improving performance | Data Management</title>
<link rel="stylesheet" href="css/syntax.css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/boxshadowproperties.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="css/theme-custom.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="data-management" href="http://localhost:4000/feed.xml">

<script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@4"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    TeX: {
      equationNumbers: {
        autoNumber: "AMS"
      }
    },
    tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$'] ],
    processEscapes: true,
  }
});
MathJax.Hub.Register.MessageHook("Math Processing Error",function (message) {
	  alert("Math Processing Error: "+message[1]);
	});
MathJax.Hub.Register.MessageHook("TeX Jax - parse error",function (message) {
	  alert("Math Processing Error: "+message[1]);
	});
</script>
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> Data Management</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>
                <!-- entries without drop-downs appear here -->




                
                
                
                <li><a href="https://github.com/vda-lab/data-management" target="_blank" rel="noopener">GitHub</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Contents<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="rdbms_landing_page.html">Relational databases and SQL</a></li>
                        
                        
                        
                        <li><a href="nosql_landing_page.html">NoSQL</a></li>
                        
                        
                        
                        <li><a href="lambda_landing_page.html">Lambda architecture</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Improving performance">{title}</a></li>',
                    noResultsText: '',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                

<ul id="mysidebar" class="nav">
  <li class="sidebarTitle">NoSQL databases </li>
  
  
  
      
  
      
  
  <li>
      <a title="Issues with relational databases" href="#">Issues with relational databases</a>
      <ul>
          
          
          
          <li><a title="Scalability and clusters" href="nosql-scalability-and-clusters.html">Scalability and clusters</a></li>
          
          
          
          
          
          
          <li><a title="Impedance mismatch" href="nosql-impedance-mismatch.html">Impedance mismatch</a></li>
          
          
          
          
          
          
          <li><a title="Relational data" href="nosql-relational-data.html">Relational data</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="General NoSQL concepts" href="#">General NoSQL concepts</a>
      <ul>
          
          
          
          <li><a title="General NoSQL concepts" href="nosql-general-concepts.html">General NoSQL concepts</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="Intermezzo - JSON" href="#">Intermezzo - JSON</a>
      <ul>
          
          
          
          <li><a title="Intermezzo - JSON" href="nosql-intermezzo-json.html">Intermezzo - JSON</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="Key/value stores" href="#">Key/value stores</a>
      <ul>
          
          
          
          <li><a title="Key/value stores" href="nosql-keyvalue-stores.html">Key/value stores</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="Document-oriented databases" href="#">Document-oriented databases</a>
      <ul>
          
          
          
          <li><a title="Introduction" href="nosql-document-databases-introduction.html">Introduction</a></li>
          
          
          
          
          
          
          <li><a title="Concepts" href="nosql-document-databases-concepts.html">Concepts</a></li>
          
          
          
          
          
          
          <li><a title="Data modelling" href="nosql-document-databases-data-modelling.html">Data modelling</a></li>
          
          
          
          
          
          
          <li><a title="Data modelling patterns" href="nosql-document-databases-data-modelling-patterns.html">Data modelling patterns</a></li>
          
          
          
          
          
          
          <li><a title="Difference with key/value stores" href="nosql-difference-with-keyvalue-stores.html">Difference with key/value stores</a></li>
          
          
          
          
          
          
          <li><a title="Implementations" href="nosql-document-databases-implementations.html">Implementations</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="Graph databases" href="#">Graph databases</a>
      <ul>
          
          
          
          <li><a title="Introduction" href="nosql-graph-databases-introduction.html">Introduction</a></li>
          
          
          
          
          
          
          <li><a title="Nomenclature" href="nosql-graph-databases-nomenclature.html">Nomenclature</a></li>
          
          
          
          
          
          
          <li><a title="Centralities" href="nosql-graph-databases-centralities.html">Centralities</a></li>
          
          
          
          
          
          
          <li><a title="Graph mining" href="nosql-graph-databases-mining.html">Graph mining</a></li>
          
          
          
          
          
          
          <li><a title="Data modelling" href="nosql-graph-databases-data-modelling.html">Data modelling</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="ArangoDB" href="#">ArangoDB</a>
      <ul>
          
          
          
          <li><a title="A multi-model database" href="nosql-arangodb-multimodel-database.html">A multi-model database</a></li>
          
          
          
          
          
          
          <li><a title="Starting with ArangoDB" href="nosql-starting-with-arangodb.html">Starting with ArangoDB</a></li>
          
          
          
          
          
          
          <li><a title="Loading data" href="nosql-arangodb-loading-data.html">Loading data</a></li>
          
          
          
          
          
          
          <li><a title="Querying key/value data" href="nosql-arangodb-querying-keyvalue-data.html">Querying key/value data</a></li>
          
          
          
          
          
          
          <li><a title="Querying document data" href="nosql-arangodb-querying-document-data.html">Querying document data</a></li>
          
          
          
          
          
          
          <li><a title="Querying graph data" href="nosql-arangodb-querying-graph-data.html">Querying graph data</a></li>
          
          
          
          
          
          
          <li class="active"><a title="Improving performance" href="nosql-arangodb-improving-performance.html">Improving performance</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="ArangoDB APIs" href="#">ArangoDB APIs</a>
      <ul>
          
          
          
          <li><a title="APIs" href="nosql-arangodb-apis.html">APIs</a></li>
          
          
          
          
          
          
          <li><a title="ArangoDB and R" href="nosql-arangodb-and-r.html">ArangoDB and R</a></li>
          
          
          
          
          
          
          <li><a title="ArangoDB and python" href="nosql-arangodb-and-python.html">ArangoDB and python</a></li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block: -->
         <!-- <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p> -->

</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <div class="post-header">
   <h1 class="post-title-main">Improving performance</h1>
</div>



<div class="post-content">

   

    


    

   <div class="seriesContext">
  
  
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
      
  
  

  
    <a href="nosql-arangodb-querying-graph-data.html"><button type="button" class="btn btn-primary">Previous: Querying graph data</button></a>
  
</div>

<p>As with any other database system, the actual setup of your database and how you write your query can have a huge impact on how fast the query runs.</p>

<h2 id="indices">Indices</h2>
<p>Consider the following query which returns all flights of the plane with tail number “N937AT”.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">FOR</span> <span class="n">f</span> <span class="k">IN</span> <span class="n">flights</span>
<span class="n">FILTER</span> <span class="n">f</span><span class="p">.</span><span class="n">TailNum</span> <span class="o">==</span> <span class="s1">'N937AT'</span>
<span class="k">RETURN</span> <span class="n">f</span></code></pre></figure>

<p>This takes more than 3 seconds to run. If we <em>explain</em> this query (click the “Explain” button instead of “Execute”), we see the following:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">Query</span> <span class="n">String</span><span class="p">:</span>
 <span class="k">FOR</span> <span class="n">f</span> <span class="k">IN</span> <span class="n">flights</span>
 <span class="n">FILTER</span> <span class="n">f</span><span class="p">.</span><span class="n">TailNum</span> <span class="o">==</span> <span class="s1">'N937AT'</span>
 <span class="k">RETURN</span> <span class="n">f</span>

<span class="n">Execution</span> <span class="n">plan</span><span class="p">:</span>
 <span class="n">Id</span>   <span class="n">NodeType</span>                    <span class="n">Est</span><span class="p">.</span>   <span class="k">Comment</span>
  <span class="mi">1</span>   <span class="n">SingletonNode</span>                  <span class="mi">1</span>   <span class="o">*</span> <span class="n">ROOT</span>
  <span class="mi">2</span>   <span class="n">EnumerateCollectionNode</span>   <span class="mi">286463</span>     <span class="o">-</span> <span class="k">FOR</span> <span class="n">f</span> <span class="k">IN</span> <span class="n">flights</span>   <span class="cm">/* full collection scan */</span>
  <span class="mi">3</span>   <span class="n">CalculationNode</span>           <span class="mi">286463</span>       <span class="o">-</span> <span class="n">LET</span> <span class="o">#</span><span class="mi">1</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nv">`TailNum`</span> <span class="o">==</span> <span class="nv">"N937AT"</span><span class="p">)</span>   <span class="cm">/* simple expression */</span>   <span class="cm">/* collections used: f : flights */</span>
  <span class="mi">4</span>   <span class="n">FilterNode</span>                <span class="mi">286463</span>       <span class="o">-</span> <span class="n">FILTER</span> <span class="o">#</span><span class="mi">1</span>
  <span class="mi">5</span>   <span class="n">ReturnNode</span>                <span class="mi">286463</span>       <span class="o">-</span> <span class="k">RETURN</span> <span class="n">f</span>

<span class="n">Indexes</span> <span class="n">used</span><span class="p">:</span>
 <span class="k">none</span>

<span class="n">Optimization</span> <span class="n">rules</span> <span class="n">applied</span><span class="p">:</span>
 <span class="k">none</span></code></pre></figure>

<p>We see that the query loops over all 286463 documents and checks for each if its <code class="language-plaintext highlighter-rouge">TailNum</code> is equal to <code class="language-plaintext highlighter-rouge">N937AT</code>. This is very expensive, as a <em>profile</em> (Click the “Profile” button) also shows:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">Query</span> <span class="n">String</span><span class="p">:</span>
 <span class="k">FOR</span> <span class="n">f</span> <span class="k">IN</span> <span class="n">flights</span>
 <span class="n">FILTER</span> <span class="n">f</span><span class="p">.</span><span class="n">TailNum</span> <span class="o">==</span> <span class="s1">'N937AT'</span>
 <span class="k">RETURN</span> <span class="n">f</span>

<span class="n">Execution</span> <span class="n">plan</span><span class="p">:</span>
 <span class="n">Id</span>   <span class="n">NodeType</span>                  <span class="n">Calls</span>    <span class="n">Items</span>   <span class="n">Runtime</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>   <span class="k">Comment</span>
  <span class="mi">1</span>   <span class="n">SingletonNode</span>                 <span class="mi">1</span>        <span class="mi">1</span>       <span class="mi">0</span><span class="p">.</span><span class="mi">00000</span>   <span class="o">*</span> <span class="n">ROOT</span>
  <span class="mi">2</span>   <span class="n">EnumerateCollectionNode</span>     <span class="mi">287</span>   <span class="mi">286463</span>       <span class="mi">1</span><span class="p">.</span><span class="mi">03926</span>     <span class="o">-</span> <span class="k">FOR</span> <span class="n">f</span> <span class="k">IN</span> <span class="n">flights</span>   <span class="cm">/* full collection scan */</span>
  <span class="mi">3</span>   <span class="n">CalculationNode</span>             <span class="mi">287</span>   <span class="mi">286463</span>       <span class="mi">0</span><span class="p">.</span><span class="mi">10772</span>       <span class="o">-</span> <span class="n">LET</span> <span class="o">#</span><span class="mi">1</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nv">`TailNum`</span> <span class="o">==</span> <span class="nv">"N937AT"</span><span class="p">)</span>   <span class="cm">/* simple expression */</span>   <span class="cm">/* collections used: f : flights */</span>
  <span class="mi">4</span>   <span class="n">FilterNode</span>                    <span class="mi">1</span>       <span class="mi">86</span>       <span class="mi">0</span><span class="p">.</span><span class="mi">17727</span>       <span class="o">-</span> <span class="n">FILTER</span> <span class="o">#</span><span class="mi">1</span>
  <span class="mi">5</span>   <span class="n">ReturnNode</span>                    <span class="mi">1</span>       <span class="mi">86</span>       <span class="mi">0</span><span class="p">.</span><span class="mi">00000</span>       <span class="o">-</span> <span class="k">RETURN</span> <span class="n">f</span>

<span class="n">Indexes</span> <span class="n">used</span><span class="p">:</span>
 <span class="k">none</span>

<span class="n">Optimization</span> <span class="n">rules</span> <span class="n">applied</span><span class="p">:</span>
 <span class="k">none</span>

<span class="n">Query</span> <span class="k">Statistics</span><span class="p">:</span>
 <span class="n">Writes</span> <span class="k">Exec</span>   <span class="n">Writes</span> <span class="n">Ign</span>   <span class="n">Scan</span> <span class="k">Full</span>   <span class="n">Scan</span> <span class="k">Index</span>   <span class="n">Filtered</span>   <span class="k">Exec</span> <span class="nb">Time</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
           <span class="mi">0</span>            <span class="mi">0</span>      <span class="mi">286463</span>            <span class="mi">0</span>     <span class="mi">286377</span>         <span class="mi">1</span><span class="p">.</span><span class="mi">32650</span>

<span class="n">Query</span> <span class="n">Profile</span><span class="p">:</span>
 <span class="n">Query</span> <span class="n">Stage</span>           <span class="n">Duration</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
 <span class="n">initializing</span>               <span class="mi">0</span><span class="p">.</span><span class="mi">00000</span>
 <span class="n">parsing</span>                    <span class="mi">0</span><span class="p">.</span><span class="mi">00012</span>
 <span class="n">optimizing</span> <span class="n">ast</span>             <span class="mi">0</span><span class="p">.</span><span class="mi">00000</span>
 <span class="n">loading</span> <span class="n">collections</span>        <span class="mi">0</span><span class="p">.</span><span class="mi">00001</span>
 <span class="n">instantiating</span> <span class="n">plan</span>         <span class="mi">0</span><span class="p">.</span><span class="mi">00007</span>
 <span class="n">optimizing</span> <span class="n">plan</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">00106</span>
 <span class="n">executing</span>                  <span class="mi">1</span><span class="p">.</span><span class="mi">32438</span>
 <span class="n">finalizing</span>                 <span class="mi">0</span><span class="p">.</span><span class="mi">00050</span></code></pre></figure>

<p>What we should do here, is create an index on <code class="language-plaintext highlighter-rouge">TailNum</code>. This will allow the system to pick those documents that match a certain tail number from a hash rather than having to check every single document. To create an index, go to <code class="language-plaintext highlighter-rouge">Collections</code>, and click on the <code class="language-plaintext highlighter-rouge">flights</code> collection. At the top you’ll see <code class="language-plaintext highlighter-rouge">Indexes</code>.</p>

<p><img src="/assets/arangodb_indices_1.png" width="600px" /></p>

<p>We’ll want to create a persistent index with the following settings (i.e. tail number is not unique across all flights, and is not sparse (in other words: tail number is almost always provided)):</p>

<p><img src="/assets/arangodb_indices_2.png" width="400px" /></p>

<p>After creating the index, an <em>explain</em> shows that we are not doing a full collection scan anymore:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">Query</span> <span class="n">String</span><span class="p">:</span>
 <span class="k">FOR</span> <span class="n">f</span> <span class="k">IN</span> <span class="n">flights</span>
 <span class="n">FILTER</span> <span class="n">f</span><span class="p">.</span><span class="n">TailNum</span> <span class="o">==</span> <span class="s1">'N937AT'</span>
 <span class="k">RETURN</span> <span class="n">f</span>

<span class="n">Execution</span> <span class="n">plan</span><span class="p">:</span>
 <span class="n">Id</span>   <span class="n">NodeType</span>        <span class="n">Est</span><span class="p">.</span>   <span class="k">Comment</span>
  <span class="mi">1</span>   <span class="n">SingletonNode</span>      <span class="mi">1</span>   <span class="o">*</span> <span class="n">ROOT</span>
  <span class="mi">6</span>   <span class="n">IndexNode</span>         <span class="mi">60</span>     <span class="o">-</span> <span class="k">FOR</span> <span class="n">f</span> <span class="k">IN</span> <span class="n">flights</span>   <span class="cm">/* persistent index scan */</span>
  <span class="mi">5</span>   <span class="n">ReturnNode</span>        <span class="mi">60</span>       <span class="o">-</span> <span class="k">RETURN</span> <span class="n">f</span>

<span class="n">Indexes</span> <span class="n">used</span><span class="p">:</span>
 <span class="k">By</span>   <span class="n">Name</span>      <span class="k">Type</span>         <span class="n">Collection</span>   <span class="k">Unique</span>   <span class="n">Sparse</span>   <span class="n">Selectivity</span>   <span class="n">Fields</span>          <span class="n">Ranges</span>
  <span class="mi">6</span>   <span class="n">TailNum</span>   <span class="n">persistent</span>   <span class="n">flights</span>      <span class="k">false</span>    <span class="k">false</span>         <span class="mi">1</span><span class="p">.</span><span class="mi">66</span> <span class="o">%</span>   <span class="p">[</span> <span class="nv">`TailNum`</span> <span class="p">]</span>   <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nv">`TailNum`</span> <span class="o">==</span> <span class="nv">"N937AT"</span><span class="p">)</span>

<span class="n">Optimization</span> <span class="n">rules</span> <span class="n">applied</span><span class="p">:</span>
 <span class="n">Id</span>   <span class="n">RuleName</span>
  <span class="mi">1</span>   <span class="n">use</span><span class="o">-</span><span class="n">indexes</span>
  <span class="mi">2</span>   <span class="n">remove</span><span class="o">-</span><span class="n">filter</span><span class="o">-</span><span class="n">covered</span><span class="o">-</span><span class="k">by</span><span class="o">-</span><span class="k">index</span>
  <span class="mi">3</span>   <span class="n">remove</span><span class="o">-</span><span class="n">unnecessary</span><span class="o">-</span><span class="n">calculations</span><span class="o">-</span><span class="mi">2</span></code></pre></figure>

<p>And indeed, running <em>profile</em> gives consistent results:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">Query</span> <span class="n">String</span><span class="p">:</span>
 <span class="k">FOR</span> <span class="n">f</span> <span class="k">IN</span> <span class="n">flights</span>
 <span class="n">FILTER</span> <span class="n">f</span><span class="p">.</span><span class="n">TailNum</span> <span class="o">==</span> <span class="s1">'N937AT'</span>
 <span class="k">RETURN</span> <span class="n">f</span>

<span class="n">Execution</span> <span class="n">plan</span><span class="p">:</span>
 <span class="n">Id</span>   <span class="n">NodeType</span>        <span class="n">Calls</span>   <span class="n">Items</span>   <span class="n">Runtime</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>   <span class="k">Comment</span>
  <span class="mi">1</span>   <span class="n">SingletonNode</span>       <span class="mi">1</span>       <span class="mi">1</span>       <span class="mi">0</span><span class="p">.</span><span class="mi">00000</span>   <span class="o">*</span> <span class="n">ROOT</span>
  <span class="mi">6</span>   <span class="n">IndexNode</span>           <span class="mi">1</span>      <span class="mi">86</span>       <span class="mi">0</span><span class="p">.</span><span class="mi">00282</span>     <span class="o">-</span> <span class="k">FOR</span> <span class="n">f</span> <span class="k">IN</span> <span class="n">flights</span>   <span class="cm">/* persistent index scan */</span>
  <span class="mi">5</span>   <span class="n">ReturnNode</span>          <span class="mi">1</span>      <span class="mi">86</span>       <span class="mi">0</span><span class="p">.</span><span class="mi">00000</span>       <span class="o">-</span> <span class="k">RETURN</span> <span class="n">f</span>

<span class="n">Indexes</span> <span class="n">used</span><span class="p">:</span>
 <span class="k">By</span>   <span class="n">Name</span>      <span class="k">Type</span>         <span class="n">Collection</span>   <span class="k">Unique</span>   <span class="n">Sparse</span>   <span class="n">Selectivity</span>   <span class="n">Fields</span>          <span class="n">Ranges</span>
  <span class="mi">6</span>   <span class="n">TailNum</span>   <span class="n">persistent</span>   <span class="n">flights</span>      <span class="k">false</span>    <span class="k">false</span>         <span class="mi">1</span><span class="p">.</span><span class="mi">66</span> <span class="o">%</span>   <span class="p">[</span> <span class="nv">`TailNum`</span> <span class="p">]</span>   <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nv">`TailNum`</span> <span class="o">==</span> <span class="nv">"N937AT"</span><span class="p">)</span>

<span class="n">Optimization</span> <span class="n">rules</span> <span class="n">applied</span><span class="p">:</span>
 <span class="n">Id</span>   <span class="n">RuleName</span>
  <span class="mi">1</span>   <span class="n">use</span><span class="o">-</span><span class="n">indexes</span>
  <span class="mi">2</span>   <span class="n">remove</span><span class="o">-</span><span class="n">filter</span><span class="o">-</span><span class="n">covered</span><span class="o">-</span><span class="k">by</span><span class="o">-</span><span class="k">index</span>
  <span class="mi">3</span>   <span class="n">remove</span><span class="o">-</span><span class="n">unnecessary</span><span class="o">-</span><span class="n">calculations</span><span class="o">-</span><span class="mi">2</span>

<span class="n">Query</span> <span class="k">Statistics</span><span class="p">:</span>
 <span class="n">Writes</span> <span class="k">Exec</span>   <span class="n">Writes</span> <span class="n">Ign</span>   <span class="n">Scan</span> <span class="k">Full</span>   <span class="n">Scan</span> <span class="k">Index</span>   <span class="n">Filtered</span>   <span class="k">Exec</span> <span class="nb">Time</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
           <span class="mi">0</span>            <span class="mi">0</span>           <span class="mi">0</span>           <span class="mi">86</span>          <span class="mi">0</span>         <span class="mi">0</span><span class="p">.</span><span class="mi">00327</span>

<span class="n">Query</span> <span class="n">Profile</span><span class="p">:</span>
 <span class="n">Query</span> <span class="n">Stage</span>           <span class="n">Duration</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
 <span class="n">initializing</span>               <span class="mi">0</span><span class="p">.</span><span class="mi">00000</span>
 <span class="n">parsing</span>                    <span class="mi">0</span><span class="p">.</span><span class="mi">00009</span>
 <span class="n">optimizing</span> <span class="n">ast</span>             <span class="mi">0</span><span class="p">.</span><span class="mi">00001</span>
 <span class="n">loading</span> <span class="n">collections</span>        <span class="mi">0</span><span class="p">.</span><span class="mi">00001</span>
 <span class="n">instantiating</span> <span class="n">plan</span>         <span class="mi">0</span><span class="p">.</span><span class="mi">00003</span>
 <span class="n">optimizing</span> <span class="n">plan</span>            <span class="mi">0</span><span class="p">.</span><span class="mi">00016</span>
 <span class="n">executing</span>                  <span class="mi">0</span><span class="p">.</span><span class="mi">00287</span>
 <span class="n">finalizing</span>                 <span class="mi">0</span><span class="p">.</span><span class="mi">00009</span></code></pre></figure>

<p>With the index, our query is 406 times faster. Instead of going over all 286463 documents in the original version, now it only checks 86.</p>

<h2 id="avoid-going-over-supernodes">Avoid going over supernodes</h2>
<p>(Note: the following is largely based on the white paper “Switching from Relational Databases to ArangoDB” available at <a href="https://www.arangodb.com/arangodb-white-papers/white-paper-switching-relational-database/">https://www.arangodb.com/arangodb-white-papers/white-paper-switching-relational-database/</a>)</p>

<p><em>Super nodes</em> are nodes in a graph with very high connectivity. Queries that touch those nodes will have to follow all those edges. Consider a database with songs information that is modelled like this:</p>

<p><img src="/assets/arangodb_songs.png" width="600px" /><br />
<small>Source: White paper mentioned above</small></p>

<p>There are 4 document collections (<code class="language-plaintext highlighter-rouge">Song</code>, <code class="language-plaintext highlighter-rouge">Artist</code>, <code class="language-plaintext highlighter-rouge">Album</code> and <code class="language-plaintext highlighter-rouge">Genre</code>), and 3 edge collections (<code class="language-plaintext highlighter-rouge">Made</code>, <code class="language-plaintext highlighter-rouge">PartOf</code> and <code class="language-plaintext highlighter-rouge">Has</code>).</p>

<p>Some of Aerosmith’s data might look like this:</p>

<p><img src="/assets/arangodb_aerosmith.png" width="400px" /><br />
<small>Source: White paper mentioned above</small></p>

<p>Suppose that we want to answer this question: ““I just listened to a song called, Tribute and I liked it very much. I suspect that there may be other songs of the same genre as this song that I might enjoy. So, I want to find all of the albums of the same genre that were released in the same year”. Here’s a first stab at such query.</p>

<p>Version 1:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">FOR</span> <span class="n">s</span> <span class="k">IN</span> <span class="n">Song</span>
  <span class="n">FILTER</span> <span class="n">s</span><span class="p">.</span><span class="n">Title</span> <span class="o">==</span> <span class="nv">"Tribute"</span>
  <span class="o">//</span> <span class="n">We</span> <span class="n">want</span> <span class="k">to</span> <span class="n">find</span> <span class="n">a</span> <span class="n">Song</span> <span class="k">called</span> <span class="n">Tribute</span>
    <span class="k">FOR</span> <span class="n">album</span> <span class="k">IN</span> <span class="mi">1</span> <span class="n">INBOUND</span> <span class="n">s</span> <span class="n">PartOf</span>
    <span class="o">//</span> <span class="n">Now</span> <span class="n">we</span> <span class="n">have</span> <span class="n">the</span> <span class="n">Album</span> <span class="n">this</span> <span class="n">Song</span> <span class="k">is</span> <span class="n">released</span> <span class="k">on</span>
      <span class="k">FOR</span> <span class="n">genre</span> <span class="k">IN</span> <span class="mi">1</span> <span class="n">OUTBOUND</span> <span class="n">album</span> <span class="n">Has</span>
      <span class="o">//</span> <span class="n">Now</span> <span class="n">we</span> <span class="n">have</span> <span class="n">the</span> <span class="n">genre</span> <span class="k">of</span> <span class="n">this</span> <span class="n">Album</span>
        <span class="k">FOR</span> <span class="n">otherAlbum</span> <span class="k">IN</span> <span class="mi">1</span> <span class="n">INBOUND</span> <span class="n">genre</span> <span class="n">Has</span>
        <span class="o">//</span> <span class="k">All</span> <span class="n">other</span> <span class="n">Albums</span> <span class="k">with</span> <span class="n">this</span> <span class="n">genre</span>
          <span class="n">FILTER</span> <span class="n">otherAlbum</span><span class="p">.</span><span class="nb">year</span> <span class="o">==</span> <span class="n">album</span><span class="p">.</span><span class="nb">year</span>
          <span class="o">//</span> <span class="k">Only</span> <span class="n">keep</span> <span class="n">those</span> <span class="k">where</span> <span class="n">the</span> <span class="nb">year</span> <span class="k">is</span> <span class="n">identical</span>
            <span class="k">RETURN</span> <span class="n">otherAlbum</span></code></pre></figure>

<p><img src="/assets/supernode_1.png" width="600px" /></p>

<p>All goes well until we hit <code class="language-plaintext highlighter-rouge">FOR otherAlbum IN 1 INBOUND genre Has</code>, because at that point it will follow all links to the albums of that genre. It’s therefore better to first select all albums of the same year, and <em>filter</em> for the genre. This way we’ll only get a limited number of albums, and each of them has only one genre.</p>

<p>Version 2:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">FOR</span> <span class="n">s</span> <span class="k">IN</span> <span class="n">Song</span>
  <span class="n">FILTER</span> <span class="n">s</span><span class="p">.</span><span class="n">Title</span> <span class="o">==</span> <span class="nv">"Tribute"</span>
  <span class="o">//</span> <span class="n">We</span> <span class="n">want</span> <span class="k">to</span> <span class="n">find</span> <span class="n">a</span> <span class="n">Song</span> <span class="k">called</span> <span class="n">Tribute</span>
    <span class="k">FOR</span> <span class="n">album</span> <span class="k">IN</span> <span class="mi">1</span> <span class="n">INBOUND</span> <span class="n">s</span> <span class="n">PartOf</span>
    <span class="o">//</span> <span class="n">Now</span> <span class="n">we</span> <span class="n">have</span> <span class="n">the</span> <span class="n">Album</span> <span class="n">this</span> <span class="n">Song</span> <span class="k">is</span> <span class="n">released</span> <span class="k">on</span>
      <span class="k">FOR</span> <span class="n">genre</span> <span class="k">IN</span> <span class="mi">1</span> <span class="n">OUTBOUND</span> <span class="n">album</span> <span class="n">Has</span>
      <span class="o">//</span> <span class="k">Get</span> <span class="n">the</span> <span class="n">genres</span> <span class="k">of</span> <span class="n">this</span> <span class="n">Album</span>
        <span class="k">FOR</span> <span class="n">otherAlbum</span> <span class="k">IN</span> <span class="n">Album</span>
        <span class="o">//</span> <span class="n">Now</span> <span class="n">we</span> <span class="n">want</span> <span class="k">all</span> <span class="n">other</span> <span class="n">Albums</span> <span class="k">of</span> <span class="n">the</span> <span class="n">same</span> <span class="nb">year</span>
          <span class="n">FILTER</span> <span class="n">otherAlbum</span><span class="p">.</span><span class="nb">Year</span> <span class="o">==</span> <span class="n">album</span><span class="p">.</span><span class="nb">Year</span>
          <span class="o">//</span> <span class="n">So</span> <span class="n">here</span> <span class="n">we</span> <span class="k">join</span> <span class="n">album</span> <span class="k">with</span> <span class="n">album</span> <span class="n">based</span> <span class="k">on</span> <span class="n">identical</span> <span class="nb">year</span>
            <span class="k">FOR</span> <span class="n">otherGenre</span> <span class="k">IN</span> <span class="mi">1</span> <span class="n">OUTBOUND</span> <span class="n">otherAlbum</span> <span class="n">Has</span>
              <span class="n">FILTER</span> <span class="n">otherGenre</span> <span class="o">==</span> <span class="n">genre</span>
              <span class="o">//</span> <span class="n">Validate</span> <span class="n">that</span> <span class="n">the</span> <span class="n">genre</span> <span class="k">of</span> <span class="n">the</span> <span class="n">other</span> <span class="n">album</span> <span class="k">is</span> <span class="n">identical</span>
              <span class="o">//</span> <span class="k">to</span> <span class="n">the</span> <span class="n">genre</span> <span class="k">of</span> <span class="n">the</span> <span class="n">original</span> <span class="n">album</span>
                <span class="k">RETURN</span> <span class="n">otherAlbum</span>
                <span class="o">//</span> <span class="n">Finally</span> <span class="k">return</span> <span class="k">all</span> <span class="n">albums</span> <span class="k">of</span> <span class="n">the</span> <span class="n">same</span> <span class="nb">year</span>
                <span class="o">//</span> <span class="k">with</span> <span class="n">the</span> <span class="n">same</span> <span class="n">genre</span></code></pre></figure>

<p><img src="/assets/supernode_2.png" width="600px" /></p>

<p>Again, a look at <em>explain</em> helps a lot here.</p>

<div class="seriesContext">
  
  
  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
      
  
  

  
    <a href="nosql-arangodb-apis.html"><button type="button" class="btn btn-primary">Next: APIs</button></a>
  
</div>



    <div class="tags">
        
    </div>




</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2021 Visual Data Analysis Lab. All rights reserved. <br />
 Site last generated: Nov 22, 2021 <br />
<p><img src="images/company_logo.png" alt="Company logo"/></p>
                </div>
            </div>
</footer>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

</html>
